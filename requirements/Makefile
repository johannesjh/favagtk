# Makefile for managing favagtk's requirements

PLATFORM=org.gnome.Platform//43
SDK=org.gnome.Sdk//43

.PHONY: python3-gnome-platform.in
python3-gnome-platform.in:
	# This target generates a list of python packages that come pre-installed on org.gnome.Platform.
	# Input: A script is run inside org.gnome.Platform which lists all python packages.
	# Output: The target writes the list of packages to a "python3-gnome-platform.in" file.
	echo "# This file was auto-generated by running make $@" > python3-gnome-platform.in
	echo "# The file lists python packages that ship with ${SDK}" >> python3-gnome-platform.in
	flatpak run ${SDK} -c "python3 -c \"import pkg_resources; print(\\\"\\\\n\\\".join([f\\\"{p.key} == {p.version}\\\" for p in pkg_resources.working_set if p.key != \\\"setuptools\\\"]))\"" >> python3-gnome-platform.in


.PHONY: pip-compile
pip-compile:
	# This target updates and freezes python dependencies using pip-compile-multi.
	# Input: This target reads dependency definitions from *.in files
	# Output: The target freezes transitive dependencies and write them to *.txt files
	pip-compile python3-gnome-platform.in > python3-gnome-platform.txt
	pip-compile --verbose python3-scikit-learn.in > python3-scikit-learn.txt
	pip-compile python3-main.in > python3-main.txt
	pip-compile python3-optional.in > python3-optional.txt
	#
	# to avoid inter-dependent requirement files,
	# remove all lines starting with -c or -r in requirement txt files:
	sed -i '/^-/d' *.txt


.PHONY: python3-main.json
python3-main.json:
	# This script generates a flatpak build module definition for main python dependencies.
	# Input: The target reads python dependencies from python3-main.txt
	# Output: The target generates a flatpak build module "python3-main.json"
	./req2flatpak.py --requirements-file python3-main.txt --target-platforms 310-x86_64 310-aarch64 > python3-main.json
	- pre-commit run --files python3-main.json > /dev/null
	echo "done creating python3-main.json"


.PHONY: python3-optional.json
python3-optional.json:
	# This script generate a flatpak build module definition for optional python dependencies.
	# Input: The target reads python dependencies from *.txt files.
	# Output: The target generates a flatpak build module "python3-optional.json"
	./req2flatpak.py --requirements-file python3-optional.txt --target-platforms 310-x86_64 310-aarch64 > python3-optional.json
	- pre-commit run --files python3-optional.json > /dev/null
	echo "done creating python3-optional.json"

.PHONY: python3-scikit-learn.json
python3-scikit-learn.json:
	# This script generate a flatpak build module definition for machine learning python dependencies.
	# Input: The target reads python dependencies from *.txt files.
	# Output: The target generates a flatpak build module "python3-scikit-learn.json"
	./req2flatpak.py --requirements-file python3-scikit-learn.txt --target-platforms 310-x86_64 310-aarch64 > python3-scikit-learn.json
	- pre-commit run --files python3-scikit-learn.json > /dev/null
	echo "done creating python3-scikit-learn.json"

