# Makefile for managing favagtk's requirements

PLATFORM=org.gnome.Platform//42
SDK=org.gnome.Sdk//42

.PHONY: update-python-platform-packages
update-python-platform-packages:
	# This target generates a list of python packages that come pre-installed on org.gnome.Platform.
	# Input: A script is run inside org.gnome.Platform which lists all python packages.
	# Output: The target writes the list of packages to a "python3-gnome-platform.in" file.
	echo "# This file was auto-generated by running make $@" > python3-gnome-platform.in
	echo "# The file lists python packages that ship with ${PLATFORM}" >> python3-gnome-platform.in
	flatpak run --user ${PLATFORM} -c "python3 -c \"import pkg_resources; print(\\\"\\\\n\\\".join([f\\\"{p.key} == {p.version}\\\" for p in pkg_resources.working_set if p.key != \\\"setuptools\\\"]))\"" >> python3-gnome-platform.in
	echo "lxml==4.8.0" >> python3-gnome-platform.in


.PHONY: update-python-dependencies
update-python-dependencies:
	# This target updates and freezes python dependencies using pip-compile-multi.
	# Input: This target reads dependency definitions from *.in files
	# Output: The target freezes transitive dependencies and write them to *.txt files
	pip-compile python3-gnome-platform.in > python3-gnome-platform.txt
	pip-compile --verbose python3-scikit-learn.in > python3-scikit-learn.txt
	pip-compile python3-main.in > python3-main.txt


.PHONY: update-python-flatpak-module
update-python-flatpak-module:
	# This script generates a flatpak build module definition for the main python dependencies.
	# Input: The target reads python dependencies from *.txt files.
	# Output: The target generates a flatpak build module "python3-main.json"
	#
	# 1. we first generate a list of favagtk dependencies to include in the flatpak module
	echo "# This file was auto-generated by running make $@" > python3-main.include.txt
	echo "# The file lists favagtk's python requirements, excluding platform packages and scikit-learn." >> python3-main.include.txt
	echo "# This is a temporary file and does not need to be kept under version control." >> python3-main.include.txt
	grep --invert-match -E '^#' ./python3-main.txt >> python3-main.include.txt
	#
	# 2. we then generate a list of favagtk dependencies to exclude from the flatpak module;
	# these are dependencies that shall be installed in different ways, or that come pre-installed as part of the platform.
	echo "# This file was auto-generated by running make $@" > python3-main.exclude.txt
	echo "# The file lists favagtk dependencies to exclude," >> python3-main.exclude.txt
	echo "#   either because they come pre-installed with ${PLATFORM}," >> python3-main.exclude.txt
	echo "#   or because we install them separately, such as scikit-learn." >> python3-main.exclude.txt
	echo "# This is a temporary file and does not need to be kept under version control." >> python3-main.exclude.txt
	grep --no-filename --only-matching -E '^[^-# ][^=~> ]*' ./python3-gnome-platform.txt ./python3-scikit-learn.txt >> python3-main.exclude.txt
	#
	# 3. we finally generate the flatpak build module
	./flatpak-pip-generator --runtime ${SDK} -r python3-main.include.txt -e $(shell grep --invert-match -E '^#' < python3-main.exclude.txt) -o python3-main
	sed -i -e "1i /* This file was auto-generated by running make $@. It defines a flatpak build module to install favagtk's main python dependencies. */" python3-main.json

